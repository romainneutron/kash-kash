applications:
  backend:
    source:
      root: backend

    type: php:8.5

    runtime:
      extensions:
        - apcu
        - pdo_pgsql
        - intl

    build:
      flavor: none

    dependencies:
      php:
        composer/composer: "^2"

    variables:
      env:
        APP_ENV: prod
        APP_DEBUG: "0"

    hooks:
      build: |
        set -e
        composer install --no-dev --optimize-autoloader --no-interaction --no-scripts
        composer dump-autoload --optimize --no-dev --classmap-authoritative
      deploy: |
        set -e
        php bin/console cache:clear --env=prod --no-debug
        php bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration

    web:
      locations:
        "/":
          root: "public"
          expires: 1h
          passthru: "/index.php"

    mounts:
      "/var": { source: storage, source_path: var }
      "/var/cache": { source: tmp, source_path: cache }
      "/var/log": { source: tmp, source_path: log }

    relationships:
      database: "postgresql:postgresql"

services:
  postgresql:
    type: postgresql:16

routes:
  "https://{default}/":
    type: upstream
    upstream: "backend:http"

  "https://www.{default}/":
    type: redirect
    to: "https://{default}/"
